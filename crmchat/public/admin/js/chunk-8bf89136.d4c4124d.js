(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-8bf89136"],{"6f2c":function(e,t,i){},7624:function(e,t,i){"use strict";t["a"]=["em-tlj-1","em-tlj-3","em-tlj-4","em-tlj-5","em-tlj-6","em-tlj-7","em-tlj-8","em-tlj-9","em-tlj-10","em-tlj-11","em-tlj-12","em-tlj-13","em-tlj-14","em-tlj-15","em-tlj-16","em-tlj-17","em-tlj-18","em-tlj-19","em-tlj-20","em-tlj-21","em-tlj-22","em-tlj-23","em-tlj-24","em-tlj-25","em-tlj-26","em-tlj-27","em-tlj-28","em-tlj-29","em-tlj-30","em-tlj-31","em-tlj-32","em-tlj-33","em-tlj-34","em-tlj-35","em-tlj-36","em-tlj-37","em-tlj-38","em-tlj-39","em-tlj-40","em-tlj-41","em-tlj-42","em-tlj-43","em-tlj-44","em-tlj-45","em-tlj-46","em-tlj-47","em-tlj-48","em-tlj-49","em-tlj-50","em-tlj-51","em-tlj-52","em-tlj-53","em-tlj-54","em-tlj-55","em-tlj-56","em-tlj-57","em-tlj-58","em-tlj-59","em-tlj-60","em-tlj-61","em-tlj-62","em-tlj-63","em-tlj-64","em-tlj-65","em-tlj-66","em-tlj-67","em-tlj-68","em-tlj-69","em-tlj-70","em-tlj-71","em-tlj-72","em-tlj-73","em-tlj-74","em-tlj-75","em-tlj-76","em-tlj-77","em-tlj-78","em-tlj-79","em-tlj-80","em-tlj-81","em-tlj-82","em-tlj-83","em-tlj-84","em-tlj-85","em-tlj-86","em-tlj-87","em-tlj-88","em-tlj-89","em-tlj-90","em-tlj-91","em-tlj-92","em-tlj-93","em-tlj-94","em-tlj-95","em-tlj-96","em-smile","em-laughing","em-blush","em-smiley","em-relaxed","em-smirk","em-heart_eyes","em-kissing_heart","em-kissing_closed_eyes","em-flushed","em-relieved","em-satisfied","em-grin","em-wink","em-stuck_out_tongue_winking_eye","em-stuck_out_tongue_closed_eyes","em-grinning","em-kissing","em-kissing_smiling_eyes","em-stuck_out_tongue","em-sleeping","em-worried","em-frowning","em-anguished","em-open_mouth","em-grimacing","em-confused","em-hushed","em-expressionless","em-unamused","em-sweat_smile","em-sweat","em-disappointed_relieved","em-weary","em-pensive","em-disappointed","em-confounded","em-fearful","em-cold_sweat","em-persevere","em-cry","em-sob","em-joy","em-astonished","em-scream","em-tired_face","em-angry","em-rage","em-triumph","em-sleepy","em-yum","em-mask","em-sunglasses","em-dizzy_face","em-imp","em-smiling_imp","em-neutral_face","em-no_mouth","em-innocent","em-alien"]},"97f1":function(e,t,i){},b223:function(e,t,i){"use strict";i("6f2c")},bac5:function(e,t,i){"use strict";i("97f1")},eea8:function(e,t,i){"use strict";i.r(t);var o=function(){var e=this,t=e._self._c;return t("div",{staticClass:"chat-room"},[t("div",{staticClass:"room",class:{win:!e.chatOptions.popup},on:{click:e.roomClick}},[t("div",{directives:[{name:"drag",rawName:"v-drag"}],staticClass:"head"},[t("div",{staticClass:"image"},[t("img",{directives:[{name:"lazy",rawName:"v-lazy",value:e.serviceData&&e.serviceData.avatar,expression:"serviceData && serviceData.avatar"}]})]),t("div",{staticClass:"name"},[e._v(e._s(e.serviceData&&e.serviceData.nickname))]),t("div",{class:["iconfont",e.muted?"icon-shengyinjingyinxianxing":"icon-shengyinyinliang"],on:{click:function(t){t.stopPropagation(),e.muted=!e.muted}}}),t("div",{staticClass:"iconfont icon-guanbi5",on:{click:function(t){return t.stopPropagation(),e.close.apply(null,arguments)}}})]),t("div",{staticClass:"main"},[t("div",{staticClass:"chat"},[t("div",{ref:"record",staticClass:"record",on:{scroll:e.onScroll}},[t("div",{ref:"scrollBox",attrs:{id:"chat_scroll"}},[t("Spin",{directives:[{name:"show",rawName:"v-show",value:e.loading,expression:"loading"}]},[t("Icon",{staticClass:"demo-spin-icon-load",attrs:{type:"ios-loading",size:"18"}}),t("div",[e._v("Loading")])],1),t("ul",[e._l(e.records,(function(i){return[t("li",{key:i.id,class:{right:i.uid===e.serviceData.tourist_uid},attrs:{id:"chat_".concat(i.id)}},[i.show?t("div",{staticClass:"time-tag"},[e._v("\n                    "+e._s(i.add_time)+"\n                  ")]):e._e(),t("div",{staticClass:"avatar"},[t("img",{directives:[{name:"lazy",rawName:"v-lazy",value:i.avatar,expression:"item.avatar"}]})]),t("div",{ref:"chatContent",refInFor:!0,staticClass:"content"},[1===i.msn_type?t("div",{staticClass:"text",domProps:{innerHTML:e._s(i.msn)}}):e._e(),2===i.msn_type?t("div",{staticClass:"image"},[t("div",{staticClass:"text"},[t("i",{class:"em ".concat(i.msn)})])]):e._e(),3===i.msn_type?t("div",{directives:[{name:"viewer",rawName:"v-viewer"}],staticClass:"image"},[t("img",{directives:[{name:"lazy",rawName:"v-lazy",value:i.msn,expression:"item.msn"}]})]):e._e(),5===i.msn_type?t("div",{staticClass:"goods"},[t("div",{staticClass:"thumb"},[t("img",{directives:[{name:"lazy",rawName:"v-lazy",value:i.productInfo.image,expression:"item.productInfo.image"}]})]),t("div",{staticClass:"intro"},[t("div",{staticClass:"name"},[e._v("\n                          "+e._s(i.productInfo.store_name)+"\n                        ")]),t("div",{staticClass:"attr"},[t("span",[e._v("库存："+e._s(i.productInfo.stock))]),t("span",[e._v("销量："+e._s(i.productInfo.sales))])]),t("div",{staticClass:"group"},[t("div",{staticClass:"money"},[e._v("\n                            ￥"+e._s(i.productInfo.price)+"\n                          ")]),t("span",{staticStyle:{cursor:"pointer"},on:{click:function(t){return t.stopPropagation(),e.onLook(i.productInfo.id)}}},[e._v("查看商品 >")])])])]):e._e(),6===i.msn_type?e._l(i.orderInfo.cartInfo,(function(o){return t("div",{key:o.id,staticClass:"order"},[t("div",{staticClass:"thumb"},[t("img",{attrs:{src:o.productInfo.image}})]),t("div",{staticClass:"intro"},[t("div",{staticClass:"name"},[e._v("\n                            订单ID："+e._s(i.orderInfo.order_id)+"\n                          ")]),t("div",{staticClass:"attr"},[e._v("商品数量："+e._s(o.cart_num))]),t("div",{staticClass:"group"},[t("div",{staticClass:"money"},[e._v("\n                              ￥"+e._s(o.productInfo.price)+"\n                            ")]),t("nuxt-link",{attrs:{target:"_blank",to:{path:"/order_detail",query:{orderId:i.orderInfo.order_id}}}},[e._v("查看订单 >")])],1)])])})):e._e()],2)])]}))],2)],1)]),t("div",{staticClass:"editor"},[t("div",{staticClass:"editor-hd"},[t("div",[t("button",{staticClass:"emoji-btn",attrs:{title:"表情"},on:{click:function(t){return t.stopPropagation(),e.emojiSwitch.apply(null,arguments)}}},[t("span",{staticClass:"iconfont iconbiaoqing1"})]),e.kufuToken?t("button",{attrs:{title:"图片"}},[t("Upload",{attrs:{"show-upload-list":!1,action:e.uploadAction,"before-upload":e.beforeUpload,format:["jpg","jpeg","png","gif"],"on-format-error":e.handleFormatError,data:e.uploadData,"on-success":e.uploadSuccess,"on-error":e.uploadError}},[t("span",{staticClass:"iconfont icontupian1"})])],1):e._e()]),e.emojiShow?t("div",{staticClass:"emoji-panel"},e._l(e.emojiList,(function(i,o){return t("i",{key:o,staticClass:"em",class:i,on:{click:function(t){return t.stopPropagation(),e.selectEmoji(i)}}})})),0):e._e()]),t("div",{staticClass:"editor-bd"},[t("textarea",{directives:[{name:"model",rawName:"v-model",value:e.chatCont,expression:"chatCont"}],attrs:{placeholder:"请输入文字内容"},domProps:{value:e.chatCont},on:{keydown:function(t){return!t.type.indexOf("key")&&e._k(t.keyCode,"enter",13,t.key,"Enter")?null:e.ctrlEnter.apply(null,arguments)},input:function(t){t.target.composing||(e.chatCont=t.target.value)}}})]),t("div",{staticClass:"editor-ft"},[t("button",{attrs:{disabled:!e.chatCont},on:{click:function(t){return t.stopPropagation(),e.sendMessage.apply(null,arguments)}}},[e._v("发送")])])])]),t("div",{staticClass:"notice"},[e.notice?t("div",{staticClass:"rich",domProps:{innerHTML:e._s(e.notice)}}):e._e(),e._m(0)])]),t("audio",{ref:"audio",attrs:{src:e.audioSrc}})]),e.change?t("feed-back",{attrs:{change:e.change},on:{closeChange:function(t){return e.closeChange(t)}}}):e._e()],1)},n=[function(){var e=this,t=e._self._c;return t("div",{staticClass:"copy"},[t("a",{attrs:{href:"http://www.crmeb.com/",target:"_blank"}},[e._v("CRMEB提供技术支持")])])}],s=i("2909"),a=(i("28a5"),i("a481"),i("ac6a"),i("f9db"),i("7624")),r=i("49ea"),c=i("d708"),l=i("a78e"),m=i.n(l),u=i("42e3"),d=function(){var e=this,t=e._self._c;return t("div",[t("div",{staticClass:"feedback",class:!0===e.change?"on":""},[t("div",{staticClass:"feedback-header acea-row"},[t("span",{staticClass:"sp1"},[e._v("Customer service not online")]),t("div",[t("Icon",{attrs:{type:"md-close",color:"#fff",size:"18"},on:{click:e.close}})],1)]),e.isShow?e._e():t("div",[t("div",{staticClass:"feedback-conent mb20"},[t("div",{staticClass:"ft",domProps:{textContent:e._s(e.notice)}})]),t("div",[t("Form",{ref:"formItem",staticClass:"pl15",attrs:{model:e.formItem,rules:e.ruleValidate}},[t("FormItem",{attrs:{prop:"rela_name"}},[t("Input",{attrs:{placeholder:"Please enter your name"},model:{value:e.formItem.rela_name,callback:function(t){e.$set(e.formItem,"rela_name",t)},expression:"formItem.rela_name"}})],1),t("FormItem",{attrs:{prop:"phone"}},[t("Input",{attrs:{placeholder:"Please enter your phone number"},model:{value:e.formItem.phone,callback:function(t){e.$set(e.formItem,"phone",t)},expression:"formItem.phone"}})],1),t("FormItem",{attrs:{prop:"content"}},[t("Input",{staticClass:"mb10",attrs:{type:"textarea",placeholder:"Please enter your message"},model:{value:e.formItem.content,callback:function(t){e.$set(e.formItem,"content",t)},expression:"formItem.content"}})],1),t("FormItem",[t("Button",{staticStyle:{width:"100%"},attrs:{type:"primary"},on:{click:function(t){return e.handleSubmit("formItem")}}},[e._v("Submit")])],1)],1)],1)]),e.isShow?t("div",{staticClass:"sure"},[t("div",{staticClass:"sure-yuan"},[t("Icon",{attrs:{type:"md-checkmark",color:"#fff",size:"30"}})],1),t("div",{staticClass:"sp1 mb10"},[e._v("Submission successful")]),t("div",{staticClass:"sp2 mb30"},[e._v("Your information has been submitted successfully, and we will contact you as soon as possible!")]),t("Button",{attrs:{type:"primary"},on:{click:e.close}},[e._v("OK")])],1):e._e()]),t("div",{directives:[{name:"show",rawName:"v-show",value:!0===e.change,expression:"change === true"}],staticClass:"maskModel",on:{touchmove:function(e){e.preventDefault()}}})])},f=[],p=(i("7f7f"),{name:"feedback",props:{change:Boolean},data:function(){return{isShow:!1,formItem:{rela_name:"",content:"",phone:""},notice:"",ruleValidate:{rela_name:[{required:!0,message:"Please enter your name",trigger:"blur"}],content:[{required:!0,message:"Please enter your message",trigger:"blur"}],phone:[{required:!0,message:"Please enter your phone number",trigger:"blur"},{validator:function(e,t,i){if(!t)return i();var o=t.replace(/\D/g,"");if(o.length<6||o.length>15)return i(new Error("Invalid phone number format"));var n=t.replace(/[\s\-().]/g,"");return/^\+?\d{6,15}$/.test(n)?i():i(new Error("Invalid phone number format"))},trigger:"blur"}]}}},mounted:function(){this.getNotice()},methods:{handleSubmit:function(e){var t=this;this.$refs[e].validate((function(e){e&&Object(u["j"])(t.formItem).then((function(e){t.isShow=!0})).cache((function(e){t.$Message.error(e.msg)}))}))},close:function(){this.$emit("closeChange",!1)},getNotice:function(){var e=this;Object(u["i"])().then((function(t){e.notice=t.data.feedback})).cache((function(t){e.$Message.error(t.msg)}))}}}),h=p,v=(i("bac5"),i("2877")),g=Object(v["a"])(h,d,f,!1,null,"eb65525c",null),_=g.exports,j=function(e,t){t=1*t||1;var i=[];return e.forEach((function(e,o){o%t===0&&i.push([]),i[i.length-1].push(e)})),i},k={name:"ChatRoom",auth:!1,components:{feedBack:_},props:{chatOptions:{type:Object,default:function(){return{show:!1}}}},directives:{drag:{inserted:function(e){var t=0,i=0,o=0,n=0,s=!1;e.onmousedown=function(a){return t=a.clientX,i=a.clientY,o=e.parentNode.offsetLeft,n=e.parentNode.offsetTop,s=!0,e.style.cursor="move",window.onmousemove=function(a){if(0!=s){var r=a.clientX,c=a.clientY,l=r-(t-o),m=c-(i-n);e.parentNode.style.left=l+"px",e.parentNode.style.top=m+"px"}},window.onmouseup=function(){s=!1,e.style.cursor="default",window.onmousemove=null,window.onmouseup=null},!1}}}},data:function(){return{locations:"".concat(location.origin),change:!1,emojiGroup:j(a["a"],20),emojiList:a["a"],emojiShow:!1,recordList:[],limit:20,loading:!1,finished:!1,chatCont:"",service:null,serviceData:{},uploadAction:"",notice:"",audio:null,muted:!1,audioSrc:"",upperId:0,uploadData:{},is_tourist:1,text:"",isLoad:!1,page:1,tourist_avatar:"",tourist_uid:"",toUid:"",kufuToken:""}},watch:{muted:function(e){this.audio.muted=e}},computed:{records:function(){var e=this;return this.recordList.map((function(t,i){return i&&new Date(t.add_time)-new Date(e.recordList[i-1].add_time)>=3e5?t.show=!0:t.show=!1,t}))}},created:function(){-1!=location.href.indexOf("kefu")&&(this.uploadAction=c["a"].apiBaseURL.replace(/adminapi/,"kefuapi")+"/tourist/upload");var e=m.a.get("auth._token.local1");this.kufuToken=e?e.split("Bearer ")[1]:""},mounted:function(){var e=this,t=this;window.addEventListener("click",(function(){t.emojiShow=!1})),this.$wechat._isMobile()&&this.$router.replace("/kefu/mobile_user_chat"),this.getNotice(),r["a"].then((function(t){e.kufuToken&&t.send({type:"login",data:e.kufuToken}),e.getService(),t.$on(["reply","chat"],(function(t){1==t.msn_type&&(t.msn=e.replace_em(t.msn)),e.recordList.push(t),setTimeout((function(t){e.$nextTick((function(){this.$refs.record.scrollTop=this.$refs.record.scrollHeight-this.$refs.record.clientHeight}))}),300)})),t.$on("to_transfer",(function(i){e.toUid=i.toUid,t.send({data:{id:e.toUid},type:"to_chat"})})),t.$on("socket_error",(function(){e.$Message.error("连接失败")})),t.$on("err_tip",(function(t){e.$Message.error(t.msg)})),t.$on("success",(function(t){e.is_tourist=0}))})),this.text=this.replace_em("[em-smiling_imp]")},beforeDestroy:function(){this.socket.close()},methods:{onLook:function(e){window.open("".concat(location.origin,"/home/goods_detail/").concat(e))},closeChange:function(e){this.change=e},sendMsg:function(e,t){var i={type:"chat",data:{msn:e,type:t,is_tourist:this.is_tourist,to_uid:this.toUid,tourist_uid:this.tourist_uid,tourist_avatar:this.tourist_avatar,form_type:this.$wechat.isWeixin()?1:3}};r["a"].then((function(e){e.send(i)}))},getService:function(){var e=this;Object(u["P"])({token:this.kufuToken||""}).then((function(t){e.serviceData=t.data,e.upperId=0,e.toUid=t.data.uid,e.tourist_uid=t.data.tourist_uid,e.tourist_avatar=t.data.tourist_avatar;var i={data:{id:t.data.uid,tourist_uid:e.tourist_uid},type:"to_chat"};r["a"].then((function(e){e.send(i)})),e.kufuToken&&e.getRecordList()})).catch((function(t){e.$Message.error(t.msg),e.change=!0}))},roomClick:function(e){},ctrlEnter:function(e){13==e.keyCode&&e.preventDefault(),this.chatCont.trim()&&this.sendMessage()},close:function(){this.$emit("chat-close")},selectEmoji:function(e){var t="[".concat(e,"]");this.chatCont+=t,this.emojiShow=!1},replace_em:function(e){return e=e.replace(/\[em-([\s\S]*)\]/g,"<span class='em em-$1'/></span>"),e},onScroll:function(e){e.target.scrollTop<=30&&this.kufuToken&&this.getRecordList()},getRecordList:function(){var e=this;this.loading||this.finished||(this.loading=!0,Object(u["g"])({uid:this.serviceData.uid,limit:this.limit,upperId:this.upperId,token:this.kufuToken}).then((function(t){if(0===t.data.length)return e.loading=!1;t.data.forEach((function(t){1==t.msn_type&&(t.msn=e.replace_em(t.msn))}));var i="";i=0==e.upperId?"chat_".concat(t.data[t.data.length-1].id):"chat_".concat(e.recordList[0].id),e.recordList=[].concat(Object(s["a"])(t.data),Object(s["a"])(e.recordList)),e.upperId=t.data.length>0?t.data[0].id:0,e.loading=!1,e.finished=t.data.length<e.limit,e.$nextTick((function(){this.setPageScrollTo(i)}))})).catch((function(t){e.$Message.error(t.msg),e.loading=!1})))},setPageScrollTo:function(e){var t=this;this.$nextTick((function(){if(e)setTimeout((function(){var i=parseFloat(document.getElementById(e).offsetTop)-60;t.$refs.record.scrollTop=i}),0);else{var i=document.querySelector("#chat_scroll");t.$refs.record.scrollTop=i.offsetHeight,setTimeout((function(e){t.$refs.record.scrollTop!=t.$refs.scrollBox.offsetHeight&&(t.$refs.record.scrollTop=document.querySelector("#chat_scroll").offsetHeight)}),300)}}))},emojiSwitch:function(){this.emojiShow=!this.emojiShow},sendMessage:function(){this.sendMsg(this.chatCont,1),this.chatCont=""},chat:function(e){var t=this;e.uid!=this.$auth.user.uid&&this.audio&&this.audio.play(),this.recordList.push(e),this.$nextTick((function(){t.$refs.record.scrollTop=t.$refs.record.scrollHeight-t.$refs.record.clientHeight}))},sendGoods:function(){var e=this;this.chatOptions.goodsId&&r["a"].then((function(t){t.send({data:{msn:e.chatOptions.goodsId,type:5,to_uid:e.toUid},type:"to_chat"})}))},sendOrder:function(){var e=this;this.chatOptions.orderId&&r["a"].then((function(t){t.send({data:{msn:e.chatOptions.orderId,type:6,to_uid:e.toUid},type:"to_chat"})}))},chatEnd:function(){navigator.userAgent.indexOf("MSIE")>0?navigator.userAgent.indexOf("MSIE 6.0")>0?(window.opener=null,window.close()):(window.open("","_top"),window.top.close()):navigator.userAgent.indexOf("Firefox")>0?window.location.href="about:blank ":(window.opener=null,window.open("","_self",""),window.close())},getNotice:function(){var e=this;Object(u["k"])().then((function(t){e.notice=t.data.content}))},beforeUpload:function(e){var t=this;this.uploadData={filename:e,token:this.kufuToken};var i=new Promise((function(e){t.$nextTick((function(){e(!0)}))}));return i},handleFormatError:function(e){this.$Message.error("上传图片只能是 jpg、jpg、jpeg、gif 格式!")},uploadSuccess:function(e){this.sendMsg(e.data.url,3)},uploadError:function(e){this.$Message.error(e)}}},w=k,y=(i("b223"),Object(v["a"])(w,o,n,!1,null,"087cccd9",null));t["default"]=y.exports},f9db:function(e,t,i){}}]);